-- Create core database if missing
CREATE DATABASE IF NOT EXISTS DEMO_DB;

-- Define primary table for cleaned Avro payload
create or replace TABLE DEMO_DB.PUBLIC.EMP_DETAILS_AVRO_CLS (
	REGISTRATION VARCHAR(16777216) NOT NULL,
	USER_ID NUMBER(38,0) NOT NULL,
	FIRST_NAME VARCHAR(16777216) NOT NULL,
	LAST_NAME VARCHAR(16777216) NOT NULL,
	USER_EMAIL VARCHAR(16777216) NOT NULL
);

-- Table for capturing ingestion errors and rejects
create or replace TABLE DEMO_DB.PUBLIC.EMPLOYEE_AVRO_REJECTS (
	ERROR VARCHAR(134217728) NOT NULL,
	FILE VARCHAR(134217728) NOT NULL,
	LINE NUMBER(38,0),
	CHARACTER NUMBER(38,0),
	BYTE_OFFSET NUMBER(38,0),
	CATEGORY VARCHAR(134217728),
	CODE NUMBER(38,0),
	SQL_STATE VARCHAR(134217728),
	COLUMN_NAME VARCHAR(134217728),
	ROW_NUMBER NUMBER(38,0),
	ROW_START_LINE NUMBER(38,0),
	REJECTED_RECORD VARCHAR(134217728)
);

-- Table for logging snowflake sessions 
create or replace TABLE DEMO_DB.PUBLIC.SESSION_AUDIT (
	SESSION_ID NUMBER(38,0) NOT NULL,
	USER_NAME VARCHAR(134217728) NOT NULL,
	WAREHOUSE VARCHAR(134217728) NOT NULL,
	ROLE VARCHAR(134217728) NOT NULL,
	CREATED_AT TIMESTAMP_NTZ(9) NOT NULL,
	CLOSED_AT TIMESTAMP_NTZ(9) NOT NULL
);


-- External stage pointing to S3 for raw Avro files
CREATE OR REPLACE STAGE raw_data_stage
  URL='s3://snowflakesmpdata'
